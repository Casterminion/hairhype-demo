import { ReactNode, useState, useEffect, createContext, useContext } from 'react';
import { NavLink, useNavigate } from 'react-router-dom';
import {
  Calendar,
  List,
  ScrollText,
  Star,
  Scissors,
  Moon,
  Sun,
  LogOut,
  Menu,
  X,
  LayoutDashboard,
  Command
} from 'lucide-react';
import { logout } from '../../hooks/useAuth';
import { CommandPalette } from './components/CommandPalette';
import { supabase } from '../../lib/supabase';

interface AppShellProps {
  children: ReactNode;
}

interface PageProps {
  children: ReactNode;
  title: string;
  subtitle?: string;
  action?: ReactNode;
}

interface ActionsProps {
  children: ReactNode;
}

type Theme = 'light' | 'dark';

const ThemeContext = createContext<Theme>('dark');

export const useTheme = () => useContext(ThemeContext);

const navItems = [
  { to: '/admin/dashboard', icon: LayoutDashboard, label: 'Apžvalga', shortLabel: 'Apžvalga' },
  { to: '/admin/calendar', icon: Calendar, label: 'Kalendorius', shortLabel: 'Kalendorius' },
  { to: '/admin/bookings', icon: List, label: 'Rezervacijos', shortLabel: 'Rezervacijos' },
  { to: '/admin/reviews', icon: Star, label: 'Atsiliepimai', shortLabel: 'Atsiliepimai' },
  { to: '/admin/services', icon: Scissors, label: 'Paslaugos', shortLabel: 'Paslaugos' },
  { to: '/admin/blogs', icon: ScrollText, label: 'Tinklaraščiai', shortLabel: 'Tinklaraščiai' },
];

export function AppShell({ children }: AppShellProps) {
  // Initialize theme from localStorage for instant load, fallback to 'dark'
  const [theme, setTheme] = useState<Theme>(() => {
    const cached = localStorage.getItem('admin_theme');
    return (cached === 'light' || cached === 'dark') ? cached : 'dark';
  });
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [commandPaletteOpen, setCommandPaletteOpen] = useState(false);
  const [themeLoaded, setThemeLoaded] = useState(false);
  const navigate = useNavigate();

  // Load theme from database on mount and sync with localStorage
  useEffect(() => {
    const loadTheme = async () => {
      try {
        const { data, error } = await supabase
          .from('settings')
          .select('value')
          .eq('key', 'admin_theme')
          .maybeSingle();

        if (!error && data?.value) {
          const dbTheme = data.value as Theme;
          setTheme(dbTheme);
          localStorage.setItem('admin_theme', dbTheme);
        } else {
          // If no database value, initialize with current localStorage value
          const currentTheme = localStorage.getItem('admin_theme') as Theme || 'dark';
          await supabase
            .from('settings')
            .upsert({
              key: 'admin_theme',
              value: currentTheme,
            });
        }
      } catch (error) {
        console.error('Failed to load theme from database:', error);
        // Fall back to localStorage on error
      } finally {
        setThemeLoaded(true);
      }
    };
    loadTheme();
  }, []);

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        setCommandPaletteOpen(true);
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, []);

  const toggleTheme = async () => {
    const newTheme = theme === 'dark' ? 'light' : 'dark';

    // Update state immediately for instant UI response
    setTheme(newTheme);

    // Update localStorage immediately for persistence across navigation
    localStorage.setItem('admin_theme', newTheme);

    // Update database in background (non-blocking)
    try {
      await supabase
        .from('settings')
        .upsert({
          key: 'admin_theme',
          value: newTheme,
        });
    } catch (error) {
      console.error('Failed to save theme to database:', error);
      // Theme still works via localStorage even if DB save fails
    }
  };

  const handleLogout = async () => {
    await logout();
    navigate('/admin/login');
  };

  return (
    <ThemeContext.Provider value={theme}>
    <div
      data-admin-theme={theme}
      className={`min-h-screen ${theme === 'dark' ? 'bg-[var(--ink)]' : 'bg-[var(--surface)]'}`}>
      {/* Top Bar - Mobile Optimized */}
      <header
        className={`
          fixed top-0 left-0 right-0 z-50
          safe-area-inset-top
          backdrop-blur-lg
          ${theme === 'dark'
            ? 'bg-[var(--ink-2)]/95 border-b border-white/[0.06]'
            : 'bg-white/95 border-b border-[var(--line)]'
          }
        `}
      >
        <div className="h-14 sm:h-16 max-w-[1920px] mx-auto px-3 sm:px-4 lg:px-8 flex items-center justify-between">
          {/* Left Side - Theme Toggle (Mobile) + Desktop Menu */}
          <div className="flex items-center gap-2 sm:gap-4">
            {/* Mobile: Theme Toggle on Left */}
            <button
              onClick={toggleTheme}
              className={`
                lg:hidden p-2.5 -ml-2 rounded-xl transition-all touch-manipulation min-w-[44px] min-h-[44px] flex items-center justify-center
                ${theme === 'dark'
                  ? 'bg-white/5 hover:bg-white/10 active:bg-white/[0.15] text-[var(--gold)]'
                  : 'bg-[var(--gold)]/10 hover:bg-[var(--gold)]/20 active:bg-[var(--gold)]/30 text-[var(--gold)]'
                }
              `}
              aria-label="Toggle theme"
            >
              {theme === 'dark' ? <Sun size={20} /> : <Moon size={20} />}
            </button>

            {/* Desktop: Hamburger Menu */}
            <button
              onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
              className="hidden lg:block p-2.5 -ml-2 rounded-xl hover:bg-white/5 active:bg-white/10 transition-colors touch-manipulation"
              aria-label="Toggle menu"
            >
              {mobileMenuOpen ? (
                <X size={22} className={theme === 'dark' ? 'text-white' : 'text-[var(--ink)]'} />
              ) : (
                <Menu size={22} className={theme === 'dark' ? 'text-white' : 'text-[var(--ink)]'} />
              )}
            </button>

            {/* Brand */}
            <h1 className={`serif text-base sm:text-xl font-semibold truncate ${theme === 'dark' ? 'text-white' : 'text-[var(--ink)]'}`}>
              <span className="hidden sm:inline">Administravimo Skydelis</span>
              <span className="sm:hidden">Admin</span>
            </h1>
          </div>

          {/* Right Side */}
          <div className="flex items-center gap-1.5 sm:gap-2">
            {/* Desktop: Command Palette */}
            <button
              onClick={() => setCommandPaletteOpen(true)}
              className={`
                hidden sm:flex items-center gap-2 px-3 py-2.5 rounded-lg transition-all touch-manipulation
                ${theme === 'dark'
                  ? 'bg-white/5 hover:bg-white/10 active:bg-white/[0.15] text-white/60 hover:text-white'
                  : 'bg-[var(--ink)]/5 hover:bg-[var(--ink)]/10 active:bg-[var(--ink)]/[0.15] text-[var(--ink)]/60 hover:text-[var(--ink)]'
                }
              `}
              title="Atidaryti komandų palėtę (⌘K)"
            >
              <Command size={18} />
              <kbd className="hidden lg:inline-block px-2 py-0.5 text-xs bg-white/5 rounded border border-white/10">⌘K</kbd>
            </button>

            {/* Desktop: Theme Toggle */}
            <button
              onClick={toggleTheme}
              className={`
                hidden lg:flex p-2.5 sm:p-3 rounded-xl transition-all touch-manipulation min-w-[44px] min-h-[44px] items-center justify-center
                ${theme === 'dark'
                  ? 'bg-white/5 hover:bg-white/10 active:bg-white/[0.15] text-[var(--gold)]'
                  : 'bg-[var(--gold)]/10 hover:bg-[var(--gold)]/20 active:bg-[var(--gold)]/30 text-[var(--gold)]'
                }
              `}
              aria-label="Toggle theme"
            >
              {theme === 'dark' ? <Sun size={18} /> : <Moon size={18} />}
            </button>

            {/* Mobile: Logout Icon Only */}
            <button
              onClick={handleLogout}
              className={`
                lg:hidden p-2.5 rounded-xl transition-all touch-manipulation min-w-[44px] min-h-[44px] flex items-center justify-center
                ${theme === 'dark'
                  ? 'bg-white/5 hover:bg-white/10 active:bg-white/[0.15] text-red-400'
                  : 'bg-red-50 hover:bg-red-100 active:bg-red-200 text-red-600'
                }
              `}
              aria-label="Atsijungti"
            >
              <LogOut size={20} />
            </button>

            {/* Desktop: Logout Button with Text */}
            <button
              onClick={handleLogout}
              className={`
                hidden lg:flex items-center gap-2 px-3 sm:px-4 py-2.5 rounded-lg font-medium text-sm touch-manipulation
                transition-all
                ${theme === 'dark'
                  ? 'bg-white/5 hover:bg-white/10 active:bg-white/[0.15] text-white/70 hover:text-white'
                  : 'bg-[var(--ink)]/5 hover:bg-[var(--ink)]/10 active:bg-[var(--ink)]/[0.15] text-[var(--ink)]/70 hover:text-[var(--ink)]'
                }
              `}
            >
              <LogOut size={18} />
              <span>Atsijungti</span>
            </button>
          </div>
        </div>
      </header>

      {/* Desktop Menu Overlay - Optimized for Touch */}
      {mobileMenuOpen && (
        <div
          className="hidden lg:block fixed inset-0 z-40 bg-black/70 backdrop-blur-sm animate-fade-in"
          onClick={() => setMobileMenuOpen(false)}
        >
          <nav
            className={`
              absolute top-14 sm:top-16 left-0 right-0 mx-3 sm:mx-4 rounded-2xl
              ${theme === 'dark' ? 'bg-[var(--ink-2)]' : 'bg-white'}
              shadow-2xl overflow-hidden animate-slide-down
            `}
            onClick={(e) => e.stopPropagation()}
          >
            <div className="py-2">
              {navItems.map((item) => (
                <NavLink
                  key={item.to}
                  to={item.to}
                  onClick={() => setMobileMenuOpen(false)}
                  className={({ isActive }) => `
                    flex items-center gap-4 px-4 sm:px-5 py-4 transition-all touch-manipulation
                    min-h-[56px] active:scale-[0.98]
                    ${isActive
                      ? theme === 'dark'
                        ? 'bg-[var(--gold)]/10 text-[var(--gold)] font-semibold'
                        : 'bg-[var(--gold)]/10 text-[var(--gold)] font-semibold'
                      : theme === 'dark'
                        ? 'text-white/80 active:bg-white/10 hover:bg-white/5'
                        : 'text-[var(--ink)]/80 active:bg-[var(--ink)]/10 hover:bg-[var(--ink)]/5'
                    }
                  `}
                >
                  <item.icon size={22} className="flex-shrink-0" />
                  <span className="font-medium text-base">{item.label}</span>
                </NavLink>
              ))}

              <div className={`h-px mx-4 my-2 ${theme === 'dark' ? 'bg-white/[0.06]' : 'bg-[var(--line)]'}`} />

              <button
                onClick={handleLogout}
                className={`
                  w-full flex items-center gap-4 px-4 sm:px-5 py-4 transition-all touch-manipulation
                  min-h-[56px] active:scale-[0.98]
                  ${theme === 'dark'
                    ? 'text-red-400 active:bg-red-500/20 hover:bg-red-500/10'
                    : 'text-red-600 active:bg-red-50 hover:bg-red-50/50'
                  }
                `}
              >
                <LogOut size={22} className="flex-shrink-0" />
                <span className="font-medium text-base">Atsijungti</span>
              </button>
            </div>
          </nav>
        </div>
      )}

      {/* Nav Rail (Desktop) */}
      <nav
        className={`
          hidden lg:block fixed left-0 top-16 bottom-0 w-20 hover:w-64
          transition-all duration-[var(--duration-spring)] ease-[var(--ease-default)]
          ${theme === 'dark'
            ? 'bg-[var(--ink-2)]/60 border-r border-white/[0.06]'
            : 'bg-white/60 border-r border-[var(--line)]'
          }
          backdrop-blur-lg z-40 overflow-hidden group
        `}
      >
        <div className="flex flex-col gap-1 p-3">
          {navItems.map((item) => (
            <NavLink
              key={item.to}
              to={item.to}
              className={({ isActive }) => `
                flex items-center gap-3 px-3 py-3 rounded-[var(--radius-md)]
                transition-all duration-[var(--duration-normal)] ease-[var(--ease-default)]
                ${isActive
                  ? 'bg-[var(--gold)]/10 text-[var(--gold)] shadow-[0_0_20px_rgba(181,142,76,0.15)]'
                  : theme === 'dark'
                    ? 'text-white/60 hover:bg-white/5 hover:text-white'
                    : 'text-[var(--ink)]/60 hover:bg-[var(--ink)]/5 hover:text-[var(--ink)]'
                }
              `}
            >
              <item.icon size={20} className="flex-shrink-0" />
              <span className="font-medium whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">
                {item.label}
              </span>
            </NavLink>
          ))}
        </div>
      </nav>

      {/* Bottom Navigation - Mobile with All 6 Sections */}
      <nav
        className={`
          lg:hidden fixed bottom-0 left-0 right-0 z-50
          backdrop-blur-xl
          ${theme === 'dark'
            ? 'bg-[var(--ink-2)]/95 border-t border-white/[0.08]'
            : 'bg-white/95 border-t border-[var(--line)]'
          }
          safe-area-inset-bottom shadow-[0_-2px_20px_rgba(0,0,0,0.1)]
        `}
      >
        <div className="flex items-stretch justify-around px-1 py-1.5 pb-safe">
          {navItems.map((item) => (
            <NavLink
              key={item.to}
              to={item.to}
              className={({ isActive }) => `
                flex flex-col items-center justify-center gap-0.5 px-1 py-1.5
                rounded-lg flex-1 min-h-[52px] max-w-[80px]
                transition-all touch-manipulation active:scale-95
                ${isActive
                  ? theme === 'dark'
                    ? 'text-[var(--gold)] bg-[var(--gold)]/10'
                    : 'text-[var(--gold)] bg-[var(--gold)]/10'
                  : theme === 'dark'
                    ? 'text-white/60 active:bg-white/5'
                    : 'text-[var(--ink)]/60 active:bg-[var(--ink)]/5'
                }
              `}
            >
              {({ isActive }) => (
                <>
                  <item.icon
                    size={20}
                    className={`flex-shrink-0 transition-transform ${isActive ? 'scale-110' : ''}`}
                    strokeWidth={isActive ? 2.5 : 2}
                  />
                  <span className={`text-[9px] font-medium leading-tight text-center ${isActive ? 'font-semibold' : ''}`}>
                    {item.shortLabel || item.label}
                  </span>
                </>
              )}
            </NavLink>
          ))}
        </div>
      </nav>

      {/* Main Content - Mobile Optimized Spacing */}
      <main className="lg:ml-20 mt-14 sm:mt-16 pb-[72px] lg:pb-8">
        <div className="max-w-7xl mx-auto px-3 sm:px-4 lg:px-8 py-4 sm:py-6 lg:py-8">
          {children}
        </div>
      </main>

      {/* Command Palette */}
      <CommandPalette isOpen={commandPaletteOpen} onClose={() => setCommandPaletteOpen(false)} />
    </div>
    </ThemeContext.Provider>
  );
}

function Page({ children, title, subtitle, action }: PageProps) {
  const theme = useTheme();
  return (
    <div className="space-y-6">
      <div className="flex items-start justify-between gap-4 flex-wrap">
        <div className="min-w-0 flex-1">
          <h1 className={`serif text-3xl lg:text-4xl font-semibold mb-2 ${theme === 'dark' ? 'text-white' : 'text-[var(--ink)]'}`}>
            {title}
          </h1>
          {subtitle && (
            <p className={`text-sm lg:text-base ${theme === 'dark' ? 'text-[var(--muted)]' : 'text-[var(--ink)]/60'}`}>
              {subtitle}
            </p>
          )}
        </div>
        {action && (
          <div className="flex items-center gap-2">
            {action}
          </div>
        )}
      </div>
      {children}
    </div>
  );
}

function Actions({ children }: ActionsProps) {
  return (
    <div className="flex items-center gap-3 flex-wrap">
      {children}
    </div>
  );
}

AppShell.Page = Page;
AppShell.Actions = Actions;
